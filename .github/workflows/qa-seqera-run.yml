name: Seqera QA

on:
  pull_request:
    branches:
      - main
  workflow_dispatch:
    inputs:
      revision:
        description: 'Git revision/branch to test (defaults to PR branch)'
        required: false
        default: ''

# Cancel in-progress runs when a new commit is pushed to the same PR
concurrency:
  group: qa-seqera-${{ github.head_ref || github.ref_name }}
  cancel-in-progress: true

jobs:
  qa-benchmark:
    name: Launch Run
    runs-on: [self-hosted, dx-pcluster]

    env:
      TOWER_ACCESS_TOKEN: ${{ secrets.TOWER_ACCESS_TOKEN }}
      TOWER_API_ENDPOINT: "https://seqera.am.lilly.com/api"
      TOWER_WORKSPACE_ID: "147963873452403"
      TOWER_COMPUTE_ENV: "42K8SORdyY4ZCzQliBu3Vc"
      PIPELINE_NAME: "hello-qa"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Validate token
        run: |
          if [[ -z "${TOWER_ACCESS_TOKEN}" ]]; then
            echo "::error::TOWER_ACCESS_TOKEN secret is not set"
            echo "Add it at: Settings -> Secrets and variables -> Actions -> New repository secret"
            exit 1
          fi

      - name: Get revision and commit SHA
        id: revision
        run: |
          if [[ -n "${{ github.event.inputs.revision }}" ]]; then
            REV="${{ github.event.inputs.revision }}"
          elif [[ -n "${{ github.head_ref }}" ]]; then
            REV="${{ github.head_ref }}"
          else
            REV="${{ github.ref_name }}"
          fi
          echo "revision=${REV}" >> $GITHUB_OUTPUT
          echo "Using revision: ${REV}"

          # Get the commit SHA for status updates
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            SHA="${{ github.event.pull_request.head.sha }}"
          else
            SHA="${{ github.sha }}"
          fi
          echo "sha=${SHA}" >> $GITHUB_OUTPUT
          echo "Commit SHA: ${SHA}"

      - name: Set pending commit status
        env:
          GH_TOKEN: ${{ secrets.DEVOPS_GITHUB_TOKEN }}
        run: |
          curl -s -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${GH_TOKEN}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "https://api.github.com/repos/${{ github.repository }}/statuses/${{ steps.revision.outputs.sha }}" \
            -d '{"state":"pending","target_url":"https://seqera.am.lilly.com/orgs/LillyOmicsHub/workspaces/LGT/watch","description":"Pipeline queued on Seqera Platform","context":"Seqera QA"}'

      - name: Deploy and launch QA pipeline
        id: seqera
        env:
          GH_TOKEN: ${{ secrets.DEVOPS_GITHUB_TOKEN }}
        run: |
          # Generate run name: QA_<repo-name>_<full_sha>
          REPO_NAME=$(basename "${{ github.repository }}")
          RUN_NAME="QA_${REPO_NAME}_${{ steps.revision.outputs.sha }}"

          # Launch pipeline (status will be updated by poll-seqera-status.yml)
          DEPLOY_OUTPUT=$(python /fsx/actions-runners/seqera-ci/seqera_cli.py deploy "${PIPELINE_NAME}" \
            --repo "https://github.com/${{ github.repository }}" \
            --revision "${{ steps.revision.outputs.revision }}" \
            --profiles awsbatch \
            --labels qa-run \
            --run-name "${RUN_NAME}" 2>&1) || {
            # Deploy command failed - update GitHub status immediately
            echo "::error::Failed to launch pipeline on Seqera Platform"
            echo "$DEPLOY_OUTPUT"
            curl -sf -X POST \
              -H "Accept: application/vnd.github+json" \
              -H "Authorization: Bearer ${GH_TOKEN}" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              "https://api.github.com/repos/${{ github.repository }}/statuses/${{ steps.revision.outputs.sha }}" \
              -d '{"state":"failure","target_url":"https://seqera.am.lilly.com/orgs/LillyOmicsHub/workspaces/LGT/watch","description":"Failed to launch on Seqera Platform","context":"Seqera QA"}'
            exit 1
          }

          echo "$DEPLOY_OUTPUT"

          # Extract workflow ID from output
          WORKFLOW_ID=$(echo "$DEPLOY_OUTPUT" | grep "WORKFLOW_ID=" | cut -d'=' -f2)

          if [[ -n "$WORKFLOW_ID" ]]; then
            # Update pending status with specific run URL
            RUN_URL="https://seqera.am.lilly.com/orgs/LillyOmicsHub/workspaces/LGT/watch/${WORKFLOW_ID}"
            curl -sf -X POST \
              -H "Accept: application/vnd.github+json" \
              -H "Authorization: Bearer ${GH_TOKEN}" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              "https://api.github.com/repos/${{ github.repository }}/statuses/${{ steps.revision.outputs.sha }}" \
              -d "{\"state\":\"pending\",\"target_url\":\"${RUN_URL}\",\"description\":\"Pipeline running on Seqera Platform\",\"context\":\"Seqera QA\"}"
            echo "Updated pending status with run URL: ${RUN_URL}"
          fi

          echo "Pipeline launched as: ${RUN_NAME}"
          echo "Poll job will check status periodically."
